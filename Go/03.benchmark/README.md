
<!-- TOC -->

- [Benchmark ğŸ§ª](#benchmark-ğŸ§ª)
  - [ç®€ä»‹](#ç®€ä»‹)
  - [å·¥ç¨‹æ„å›¾](#å·¥ç¨‹æ„å›¾)
  - [åˆå§‹åŒ–å·¥ç¨‹](#åˆå§‹åŒ–å·¥ç¨‹)
  - [Test](#test)
  - [Benchmark](#benchmark)
  - [è¿è¡Œæµ‹è¯•](#è¿è¡Œæµ‹è¯•)

<!-- /TOC -->

# 1. Benchmark ğŸ§ª

## 1.1. ç®€ä»‹

> åŸºå‡†æµ‹è¯•æ˜¯å¯¹è®¡ç®—æœºç³»ç»Ÿçš„æ€§èƒ½çš„æµ‹è¯•ã€‚

åœ¨ç¨‹åºä¸­ï¼ŒåŸºå‡†æµ‹è¯•ï¼Œæ˜¯ä¸€ç§æµ‹è¯•ä»£ç æ€§èƒ½çš„æ–¹æ³•ï¼›æ¯”å¦‚æœ‰ä¸€ä¸ªé—®é¢˜ä½ æœ‰å¤šç§ä¸åŒçš„æ–¹æ¡ˆï¼Œä½ æƒ³é€‰æ‹©ä¸€ç§æ€§èƒ½æœ€å¥½çš„æ–¹æ¡ˆï¼Œé‚£ä¹ˆä½ å°±éœ€è¦åŸºå‡†æµ‹è¯•ã€‚

> åŸºå‡†æµ‹è¯•ä¸»è¦æ˜¯é€šè¿‡æµ‹è¯• CPU å’Œå†…å­˜çš„æ•ˆç‡é—®é¢˜ï¼Œæ¥è¯„ä¼°è¢«æµ‹è¯•ä»£ç çš„æ€§èƒ½ï¼Œè¿›è€Œæ‰¾åˆ°æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚æ¯”å¦‚é“¾æ¥æ± çš„æ•°é‡ä¸æ˜¯è¶Šå¤šè¶Šå¥½ï¼Œé‚£ä¹ˆå“ªä¸ªå€¼æ‰æ˜¯æœ€ä¼˜å€¼å‘¢ï¼Œè¿™å°±éœ€è¦é…åˆåŸºå‡†æµ‹è¯•ä¸æ–­è°ƒä¼˜äº†ã€‚

## 1.2. å·¥ç¨‹æ„å›¾

ä»“åº“ï¼š <https://github.com/guzhongren/TDD/tree/master/09.benchmar>

æ ¹æ®è¾“å…¥çš„å­—ç¬¦ä¸²å’Œé‡å¤æ¬¡æ•°ï¼Œè¾“å‡ºé‡å¤æ¬¡æ•°åçš„å­—ç¬¦ä¸²ã€‚

## 1.3. åˆå§‹åŒ–å·¥ç¨‹

```shell
go mod init benchmark
```

æµ‹è¯•çš„å‡½æ•°éœ€è¦ä»¥ Test å¼€å¤´ï¼Œå‚æ•°ä¸º *testing.T ç±»å‹

## 1.4. Test

* æµ‹è¯•å…ˆè¡Œ
```go
# æµ‹è¯• Repeat å‡½æ•°
func TestRepeat(t *testing.T) {
	actual := Repeat(`a`, 6)
	expect := `aaaaaa`
	if actual != expect {
		t.Errorf(`expect %s, but got %s`, expect, actual)
	}
}
```
* è¿è¡Œ **go test**, ç¨‹åºä¼šæŠ¥é”™ï¼Œå› ä¸ºæ²¡æœ‰å®ç° Repeat å‡½æ•°ã€‚

* æœ€å°åŒ–çš„å®ç° Repeat

```go
// Repeat return a string with same char
func Repeat(char string, count int) (result string) {
	for i := 0; i < count; i++ {
		result += char
	}
	return
}
```

ä¸Šé¢çš„å‡½æ•°ä¸­ return å¹¶æ²¡æœ‰è¿”å›å€¼ï¼Œæ˜¯å› ä¸ºï¼Œåœ¨ Repeat å‡½æ•°çš„è¿”å›å€¼éƒ¨åˆ†æœ‰ä¸€ä¸ªresultï¼Œ
å½“è¿”å›å€¼æ˜¯å‡½æ•°ä½“é‡Œé¢çš„å€¼çš„æ—¶å€™ï¼Œå¯ä»¥ä¸ç”¨å†™è¿”å›å€¼ï¼Œgo ç¨‹åºè‡ªåŠ¨å°†è¯¥å€¼è¿”å›ã€‚ä½†return ä¾æ—§ä¸èƒ½çœç•¥ã€‚

## 1.5. Benchmark

åŸºå‡†æµ‹è¯•çš„å‡½æ•°åé¡»ä»¥ Benchmark å¼€å¤´ï¼Œ å‚æ•°é¡»ä¸º *testing.Bï¼›å¾ªç¯ä¸­çš„ b.Nï¼Œ go ä¼šæ ¹æ®ç³»ç»Ÿæƒ…å†µç”Ÿæˆï¼Œä¸ç”¨ç”¨æˆ·è®¾å®šã€‚

```go
func BenchmarkRepeat(b *testing.B) {
	for i := 0; i < b.N; i++ {
		Repeat(`b`, 5)
	}
}

```

## 1.6. è¿è¡Œæµ‹è¯•

* åŸºæœ¬æµ‹è¯•

```shell
$ go test
PASS
ok      benchmark       0.006s
```

åŸºæœ¬æµ‹è¯•å¾ˆç®€å•ï¼Œä¸ç”¨è§£è¯»äº†ã€‚

* åŸºå‡†æµ‹è¯•

```shell
$ go test -bench=. -run=none
goos: darwin
goarch: amd64
pkg: benchmark
BenchmarkRepeat-12      10000000               116 ns/op
PASS
ok      benchmark       1.297s
```

è¿è¡ŒåŸºå‡†æµ‹è¯•ä¹Ÿè¦ä½¿ç”¨go testå‘½ä»¤ï¼Œä¸è¿‡æˆ‘ä»¬è¦åŠ ä¸Š-bench=æ ‡è®°ï¼Œå®ƒæ¥å—ä¸€ä¸ªè¡¨è¾¾å¼ä½œä¸ºå‚æ•°ï¼ŒåŒ¹é…åŸºå‡†æµ‹è¯•çš„å‡½æ•°ï¼Œ. è¡¨ç¤ºè¿è¡Œæ‰€æœ‰åŸºå‡†æµ‹è¯•ã€‚

å› ä¸ºé»˜è®¤æƒ…å†µä¸‹ go test ä¼šè¿è¡Œå•å…ƒæµ‹è¯•ï¼Œä¸ºäº†é˜²æ­¢å•å…ƒæµ‹è¯•çš„è¾“å‡ºå½±å“æˆ‘ä»¬æŸ¥çœ‹åŸºå‡†æµ‹è¯•çš„ç»“æœï¼Œå¯ä»¥ä½¿ç”¨-run=åŒ¹é…ä¸€ä¸ªä»æ¥æ²¡æœ‰çš„å•å…ƒæµ‹è¯•æ–¹æ³•ï¼Œè¿‡æ»¤æ‰å•å…ƒæµ‹è¯•çš„è¾“å‡ºï¼Œæˆ‘ä»¬è¿™é‡Œä½¿ç”¨noneï¼Œå› ä¸ºæˆ‘ä»¬åŸºæœ¬ä¸Šä¸ä¼šåˆ›å»ºè¿™ä¸ªåå­—çš„å•å…ƒæµ‹è¯•æ–¹æ³•ã€‚

ä¸‹é¢ç€é‡è§£é‡Šä¸‹è¯´å‡ºçš„ç»“æœï¼Œçœ‹åˆ°å‡½æ•°åé¢çš„-12äº†å—ï¼Ÿè¿™ä¸ªè¡¨ç¤ºè¿è¡Œæ—¶å¯¹åº”çš„ GOMAXPROCS çš„å€¼ã€‚æ¥ç€çš„ 10000000 è¡¨ç¤ºè¿è¡Œ for å¾ªç¯çš„æ¬¡æ•°ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨è¢«æµ‹è¯•ä»£ç çš„æ¬¡æ•°ï¼Œæœ€åçš„ 116 ns/opè¡¨ç¤ºæ¯æ¬¡éœ€è¦è¯è´¹ 116 çº³ç§’ã€‚
ä»¥ä¸Šæ˜¯æµ‹è¯•æ—¶é—´é»˜è®¤æ˜¯1ç§’ï¼Œä¹Ÿå°±æ˜¯1ç§’çš„æ—¶é—´ï¼Œè°ƒç”¨ 10000000 æ¬¡ï¼Œæ¯æ¬¡è°ƒç”¨èŠ±è´¹ 116 çº³ç§’ã€‚å¦‚æœæƒ³è®©æµ‹è¯•è¿è¡Œçš„æ—¶é—´æ›´é•¿ï¼Œå¯ä»¥é€šè¿‡ -lunchtime æŒ‡å®šï¼Œæ¯”å¦‚5ç§’ã€‚
